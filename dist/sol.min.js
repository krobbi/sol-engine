/**
* @name Sol
* @description Lightweight JavaScript game engine.
* @version 0.2.0
* @license {@link https://krobbi.github.io/license/2020/mit.txt|MIT License}
* @author Chris Roberts (Krobbizoid)
* @copyright 2020 Chris Roberts
*/
var Sol=function(){"use strict";class t{constructor(){this._loaded=!1,this._missing=!1}set loaded(t){this._loaded=t}set missing(t){this._missing=t}get loaded(){return this._loaded}get missing(){return this._missing}}function e(t,e,s){return t.hasOwnProperty(e)?t[e]:s}class s{constructor(t){this._game=t,this._assets={}}_allocate(t){return t in this._assets||(this._assets[t]=[]),this._assets[t]}load(t,s){const i=e(s,"json",{}),r=e(s,"textures",{});for(let s in i){const r=e(i[s],"src","data:application/json,{}");this.loadJsonFile(t,s,r)}for(let s in r){const i=r[s],n=e(i,"src",""),h=e(i,"width",0),a=e(i,"height",0);this.loadTexture(t,s,n,h,a)}}loadJsonFile(t,e,s){this._allocate(t).push(this._game.json.load(e,s))}loadTexture(t,e,s,i=0,r=0){this._allocate(t).push(this._game.texture.load(e,s,i,r))}progress(t){const e=this._allocate(t);let s=0;for(let t of e)t.loaded&&s++;return s>=e.length?(this._assets[t]=[],1):s/e.length}complete(t){return this.progress(t)>=1}onStop(){for(let t in this._assets)this._assets[t]=[]}}const i={VERSION:"0.2.0",LICENSE:"MIT",LICENSE_URL:"https://krobbi.github.io/license/2020/mit.txt",COPYRIGHT:"Chris Roberts",COPYRIGHT_YEAR:"2020",NONE:0,WEBGL:1,CANVAS:2};function r(t){let e;switch(t.gfx.renderer.type){case i.NONE:e="No";break;case i.WEBGL:e="WebGL";break;case i.CANVAS:e="Canvas";break;default:e="Unknown"}console.log([`%c Sol v${i.VERSION} `,`%c ${e} renderer `,` ${i.LICENSE} License - ${i.LICENSE_URL} `,` Copyright (c) ${i.COPYRIGHT_YEAR} ${i.COPYRIGHT} `].join("\n"),"background:#080808;color:#f77f00;font-size:medium;font-weight:bold;","background:#080808;color:#f3d180;")}function n(){const t=[typeof document,typeof document.readyState,typeof setInterval,typeof clearInterval,typeof requestAnimationFrame];for(let e of t)if("undefined"==e)return!1;return!0}function h(t,e,s){return Math.min(s,Math.max(e,t))}class a{constructor(t={}){this.canvas=e(t,"canvas",".sol-canvas-parent"),this.renderer=e(t,"renderer",i.WEBGL),this.width=e(t,"width",800),this.height=e(t,"height",600),this.glMaxTextures=h(e(t,"glMaxTextures",32),1,32),this.glMaxVerts=h(e(t,"glMaxVerts",16384),6,65536)}}class o{constructor(t={}){this.enabled=!!e(t,"enabled",!0)}}class _{constructor(t={}){this.main=e(t,"main","main"),this.scenes=e(t,"scenes",{})}}class l{constructor(t={}){this.autoStart=!!e(t,"autoStart",!1),this.gfx=new a(e(t,"gfx",{})),this.key=new o(e(t,"key",{})),this.scene=new _(e(t,"scene",{}))}}class u{constructor(t){this._game=t,this._starting=!1,this._running=!1,this._stopping=!1,this._timeNow=0,this._timeLast=0,this._delta=0}_step(){if(this._delta=(this._timeNow-this._timeLast)/1e3,this._onUpdate(),this._stopping)return this._onStop(),this._running=!1,void(this._stopping=!1);requestAnimationFrame(t=>{this._timeLast=this._timeNow,this._timeNow=t,this._step()})}start(){if(this._starting||this._running&&!this._stopping||!n())return!1;this._starting=!0;const t=setInterval(()=>{this._running||"complete"!=document.readyState||(clearInterval(t),this._running=!0,this._stopping=!1,this._onStart(),this._starting=!1,this._step())});return!0}restart(){return this.stop(),this.start()}stop(){return!(!this._running||this._stopping||(this._stopping=!0,0))}_onStart(){this._game.gfx.onStart(),r(this._game),this._game.texture.onStart(),this._game.key.onStart(),this._game.scene.onStart()}_onUpdate(){this._game.time.onPreTick(this._delta),this._game.key.onPreTick(),this._game.scene.onTick(),this._game.gfx.onPreDraw(),this._game.scene.onDraw(),this._game.gfx.onPostDraw()}_onStop(){this._game.scene.onStop(),this._game.key.onStop(),this._game.loader.onStop(),this._game.texture.onStop(),this._game.json.onStop(),this._game.gfx.onStop()}get running(){return this._running}}class c{constructor(){this.innerHTML="",this.attributes={}}clear(){return this.innerHTML="",this.attributes={},this}save(t){this.innerHTML=t.innerHTML,this.attributes={};for(let e of t.attributes)this.attributes[e.name]=e.value;return this}restore(t){for(t.innerHTML=this.innerHTML;t.attributes.length>0;)t.removeAttribute(t.attributes[0].name);for(let e in this.attributes)t.setAttribute(e,this.attributes[e]);return this}}function g(){}class d{constructor(t,e,s,i){this._targets=Array.isArray(t)?t:[t],this._types=Array.isArray(e)?e:[e],this._listener=s,this._options=i,this._active=!1}start(){if(this._active||0==this._targets.length||0==this._types.length)return!1;for(let t of this._targets)for(let e of this._types)t.addEventListener(e,this._listener,this._options);return this._active=!0,!0}stop(){if(!this._active)return!1;for(let t of this._targets)for(let e of this._types)t.removeEventListener(e,this._listener,this._options);return this._active=!1,!0}destroy(){this.stop(),this._targets=[],this._types=[],this._listener=g,this._options=!1}get active(){return this._active}}class f{constructor(t,e){this._type=t,this._canvas=e,this._width=2,this._height=2}resize(t,e){this._canvas.width=this._width=t,this._canvas.height=this._height=e,this._onResize()}clear(){}applyTexture(t){}drawTexture(t,e,s,i,r,n,h,a){}destroy(){}_onResize(){}onPreDraw(){}onPostDraw(){}get type(){return this._type}get width(){return this._width}get height(){return this._height}get gl(){return null}get ctx(){return null}}class m extends f{constructor(t,e){super(i.CANVAS,t),this._ctx=e,this._img=t,this._cropScaleX=1,this._cropScaleY=1}clear(){this._ctx.fillStyle="#000000",this._ctx.fillRect(0,0,this._width,this._height)}applyTexture(t){this._img=t.canvasImg,this._cropScaleX=t.canvasCropScaleX,this._cropScaleY=t.canvasCropScaleY}drawTexture(t,e,s,i,r,n,h,a){r*=this._cropScaleX,n*=this._cropScaleY,h*=this._cropScaleX,a*=this._cropScaleY,this._ctx.drawImage(this._img,r,n,h,a,t,e,s,i)}destroy(){this._ctx.clearRect(0,0,this._width,this._height)}_onResize(){this._ctx.imageSmoothingEnabled=!1}onPreDraw(){this.clear()}get ctx(){return this._ctx}}const p={mainFrag:"precision mediump float;uniform sampler2D uTex[%MAX_TEXTURES%];varying float vTexID;varying vec2 vUV;varying vec4 vTint;void main(){vec4 texel;%GET_TEXEL%gl_FragColor=vTint*texel;}",mainVert:"precision mediump float;uniform mat4 uMVP;attribute vec2 aPos;attribute float aTexID;attribute vec2 aUV;attribute vec4 aTint;varying float vTexID;varying vec2 vUV;varying vec4 vTint;void main(){gl_Position=uMVP*vec4(aPos,1.0,1.0);vTexID=aTexID;vUV=aUV;vTint=aTint;}"};function T(t,e,s){let i;switch(e){case t.VERTEX_SHADER:i="vertex";break;case t.FRAGMENT_SHADER:i="fragment";break;default:return console.error(`Invalid shader type: ${e}`),null}const r=t.createShader(e);if(!r)return console.error(`Failed to create a ${i} shader!`),t.deleteShader(r),null;if(t.shaderSource(r,s),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){const e=t.getShaderInfoLog(r);return console.error(`Failed to compile a ${i} shader:\n${e}`),t.deleteShader(r),null}return r}function E(t,e,s,i,r,n){let h="";for(let t=0;t<e;t++)t>0&&(h+="else "),t<e-1&&(h+=`if(${r}==${t}.0)`),h+=`${s}=texture2D(${i}[${t}],${n});`;return t.replace("%MAX_TEXTURES%",`${e}`).replace("%GET_TEXEL%",h)}class x{constructor(){this.x=0,this.y=0,this.w=1,this.h=1}clone(){return(new x).copy(this)}copy(t){return this.x=t.x,this.y=t.y,this.w=t.w,this.h=t.h,this}identity(){return this.x=this.y=0,this.w=this.h=1,this}translate(t,e){return this.x+=t,this.y+=e,this}scale(t,e){return this.w*=t,this.h*=e,this}multiply(t){return this.x=t.x*this.w+this.x,this.y=t.y*this.h+this.y,this.w*=t.w,this.h*=t.h,this}}class v{constructor(t,e){this._program=t,this._uniform=e,this._dirty=!1,this._matP=new x,this._value=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}projection(t,e){this._matP.x=-1,this._matP.y=1,this._matP.w=2/t,this._matP.h=-2/e,this._dirty=!0}update(){this._dirty&&(this._value[0]=this._matP.w,this._value[5]=this._matP.h,this._value[12]=this._matP.x,this._value[13]=this._matP.y,this._program.setUm4fv(this._uniform,!1,this._value),this._dirty=!1)}}class y{constructor(t,e,s,i,r,n,h,a){this._gl=t,this._uniforms={},this._attribs={},this._program=t.createProgram();const o=T(t,t.VERTEX_SHADER,p[e]),_=T(t,t.FRAGMENT_SHADER,E(p[s],i,r,n,h,a));if(!o||!_)return t.deleteShader(o),void t.deleteShader(_);if(t.attachShader(this._program,o),t.attachShader(this._program,_),t.linkProgram(this._program),t.detachShader(this._program,o),t.detachShader(this._program,_),t.deleteShader(o),t.deleteShader(_),!t.getProgramParameter(this._program,t.LINK_STATUS)){const e=t.getProgramInfoLog(this._program);return void console.error(`Failed to link a program:\n${e}`)}const l=t.getProgramParameter(this._program,t.ACTIVE_UNIFORMS),u=t.getProgramParameter(this._program,t.ACTIVE_ATTRIBUTES);let c;for(let e=0;e<l;e++){const s=(c=t.getActiveUniform(this._program,e)).name.replace(/(\[[0-9]*\])+/g,"");this._uniforms[s]=t.getUniformLocation(this._program,c.name)}for(let e=0;e<u;e++){const s=(c=t.getActiveAttrib(this._program,e)).name.replace(/(\[[0-9]*\])+/g,"");this._attribs[s]=t.getAttribLocation(this._program,c.name)}}use(){this._gl.useProgram(this._program)}unuse(){this._gl.useProgram(null)}destroy(){this.use();for(let t in this._attribs)this._gl.disableVertexAttribArray(this._attribs[t]);this.unuse(),this._gl.deleteProgram(this._program)}setU1i(t,e){this._gl.uniform1i(this._uniforms[t],e)}setU1iv(t,e){this._gl.uniform1iv(this._uniforms[t],e)}setU2i(t,e,s){this._gl.uniform2i(this._uniforms[t],e,s)}setU2iv(t,e){this._gl.uniform2iv(this._uniforms[t],e)}setU3i(t,e,s,i){this._gl.uniform3i(this._uniforms[t],e,s,i)}setU3iv(t,e){this._gl.uniform3iv(this._uniforms[t],e)}setU4i(t,e,s,i,r){this._gl.uniform4i(this._uniforms[t],e,s,i,r)}setU4iv(t,e){this._gl.uniform4iv(this._uniforms[t],e)}setU1f(t,e){this._gl.uniform1f(this._uniforms[t],e)}setU1fv(t,e){this._gl.uniform1fv(this._uniforms[t],e)}setU2f(t,e,s){this._gl.uniform2f(this._uniforms[t],e,s)}setU2fv(t,e){this._gl.uniform2fv(this._uniforms[t],e)}setU3f(t,e,s,i){this._gl.uniform3f(this._uniforms[t],e,s,i)}setU3fv(t,e){this._gl.uniform3fv(this._uniforms[t],e)}setU4f(t,e,s,i,r){this._gl.uniform4f(this._uniforms[t],e,s,i,r)}setU4fv(t,e){this._gl.uniform4fv(this._uniforms[t],e)}setUm2fv(t,e,s){this._gl.uniformMatrix2fv(this._uniforms[t],e,s)}setUm2fvID(t){this.setUm2fv(t,!1,new Float32Array([1,0,0,1]))}setUm3fv(t,e,s){this._gl.uniformMatrix3fv(this._uniforms[t],e,s)}setUm3fvID(t){this.setUm3fv(t,!1,new Float32Array([1,0,0,0,1,0,0,0,1]))}setUm4fv(t,e,s){this._gl.uniformMatrix4fv(this._uniforms[t],e,s)}setUm4fvID(t){this.setUm4fv(t,!1,new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]))}setAp(t,e,s,i,r,n){const h=this._attribs[t];this._gl.enableVertexAttribArray(h),this._gl.vertexAttribPointer(h,e,s,i,r,n)}setAp1f(t,e,s){this.setAp(t,1,this._gl.FLOAT,!1,e,s)}setAp2f(t,e,s){this.setAp(t,2,this._gl.FLOAT,!1,e,s)}setAp3f(t,e,s){this.setAp(t,3,this._gl.FLOAT,!1,e,s)}setAp4f(t,e,s){this.setAp(t,4,this._gl.FLOAT,!1,e,s)}setAp1ub(t,e,s,i){this.setAp(t,1,this._gl.UNSIGNED_BYTE,e,s,i)}setAp2ub(t,e,s,i){this.setAp(t,2,this._gl.UNSIGNED_BYTE,e,s,i)}setAp3ub(t,e,s,i){this.setAp(t,3,this._gl.UNSIGNED_BYTE,e,s,i)}setAp4ub(t,e,s,i){this.setAp(t,4,this._gl.UNSIGNED_BYTE,e,s,i)}}class A{constructor(t,e,s,i){this._factory=t.texture.factory,this._gl=e,this._buffer=s,this._MAX_TEXTURES=i,this._pointer=0,this._tempTextures=[],this._boundTextures=[],this.id=0,this.width=1,this.height=1;for(let t=0;t<this._MAX_TEXTURES;t++){this._tempTextures.push(this._factory.glCreatePixel(e,0,0,0,0));const s=this._tempTextures[t];e.activeTexture(e.TEXTURE0+t),e.bindTexture(e.TEXTURE_2D,s.glTex),this._factory.glReturnUnit=s.glUnit=t,this._factory.glReturnTex=s.glTex,this._boundTextures.push(s),s.glBound=!0}e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this._boundTextures[0].glTex),this._factory.glReturnUnit=0,this._factory.glReturnTex=this._boundTextures[0].glTex}applyTexture(t){if(t.glBound)return this.id=t.glUnit,this.width=t.width,void(this.height=t.height);this._pointer>=this._MAX_TEXTURES&&this.flush(),this._gl.activeTexture(this._gl.TEXTURE0+this._pointer),this._gl.bindTexture(this._gl.TEXTURE_2D,t.glTex),this._factory.glReturnUnit=t.glUnit=this._pointer,this._factory.glReturnTex=t.glTex,this._boundTextures[this._pointer]=t,t.glBound=!0,this._pointer++}flush(){this._buffer.flush();for(let t=0;t<this._MAX_TEXTURES;t++)this._boundTextures[t].glBound=!1;this._pointer=0}destroy(){for(let t=0;t<this._MAX_TEXTURES;t++)this._factory.destroyTexture(this._gl,this._tempTextures[t]);this._tempTextures=[],this._boundTextures=[]}}class w{constructor(t,e,s,i,r,n,h,a){this._gl=t,this._program=e,this._mvp=s,this._MAX_VERTS=i,this._COMPONENTS_PER_VERT=6,this._BYTES_PER_VERT=4*this._COMPONENTS_PER_VERT,this._offset=0;const o=i*this._BYTES_PER_VERT;this._vertData=new ArrayBuffer(o),this._vertF32=new Float32Array(this._vertData),this._vertU32=new Uint32Array(this._vertData),this._vertU8=new Uint8Array(this._vertData),this._buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._buffer),t.bufferData(t.ARRAY_BUFFER,o,t.STREAM_DRAW),this._program.setAp2f(r,this._BYTES_PER_VERT,0),this._program.setAp1f(n,this._BYTES_PER_VERT,8),this._program.setAp2f(h,this._BYTES_PER_VERT,12),this._program.setAp4ub(a,!0,this._BYTES_PER_VERT,20)}pushVert(t,e,s,i,r,n){let h=this._offset*this._COMPONENTS_PER_VERT;const a=this._vertF32,o=this._vertU32;a[h++]=t,a[h++]=e,a[h++]=s,a[h++]=i,a[h++]=r,o[h++]=n,this._offset++}pushQuad(t,e,s,i,r,n,h,a,o,_){this._offset+6>this._MAX_VERTS&&this.flush(),this.pushVert(t,e,r,n,h,_),this.pushVert(t,i,r,n,o,_),this.pushVert(s,e,r,a,h,_),this.pushVert(s,e,r,a,h,_),this.pushVert(t,i,r,n,o,_),this.pushVert(s,i,r,a,o,_)}flush(){this._mvp.update(),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,this._vertU8.subarray(0,this._offset*this._BYTES_PER_VERT)),this._gl.drawArrays(this._gl.TRIANGLES,0,this._offset),this._offset=0}destroy(){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,null),this._gl.deleteBuffer(this._buffer)}}class S extends f{constructor(t,e,s,r,n){super(i.WEBGL,e),this._gl=s,s.disable(s.CULL_FACE),s.disable(s.DEPTH_TEST),s.disable(s.DITHER),s.disable(s.POLYGON_OFFSET_FILL),s.disable(s.SAMPLE_ALPHA_TO_COVERAGE),s.disable(s.SAMPLE_COVERAGE),s.disable(s.SCISSOR_TEST),s.disable(s.STENCIL_TEST),s.enable(s.BLEND),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.clearColor(0,0,0,1),r=h(s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS),1,r);const a=new Int32Array(r);for(let t=0;t<r;t++)a[t]=t;this._program=new y(s,"mainVert","mainFrag",r,"texel","uTex","vTexID","vUV"),this._program.use(),this._program.setU1iv("uTex",a),this._program.setUm4fvID("uMVP"),this._mvp=new v(this._program,"uMVP"),this._vertBuffer=new w(s,this._program,this._mvp,n,"aPos","aTexID","aUV","aTint"),this._textureCache=new A(t,s,this._vertBuffer,r)}clear(){this._gl.clear(this._gl.COLOR_BUFFER_BIT)}applyTexture(t){this._textureCache.applyTexture(t)}drawTexture(t,e,s,i,r,n,h,a){const o=this._textureCache;s+=t,i+=e,h=(h+r)/o.width,a=(a+n)/o.height,r/=o.width,n/=o.height,this._vertBuffer.pushQuad(t,e,s,i,o.id,r,n,h,a,4294967295)}destroy(){this._textureCache.destroy(),this._vertBuffer.destroy(),this._program.destroy(),this._gl.clearColor(0,0,0,0),this._gl.clear(this._gl.COLOR_BUFFER_BIT),this._gl.flush()}_onResize(){this._gl.viewport(0,0,this._width,this._height),this._mvp.projection(this._width,this._height)}onPreDraw(){this.clear()}onPostDraw(){this._vertBuffer.flush()}get gl(){return this._gl}}class R{constructor(t,e){this._game=t,this._config=e,this._canvasGenerated=!1,this._canvasMemento=new c,this.canvas,this.renderer}_initCanvas(t){this._canvasGenerated?t.classList.add("sol-generated"):this._canvasMemento.save(t),t.innerHTML=null,t.removeAttribute("title"),t.classList.add("sol","sol-canvas"),t.style.setProperty("background","#000"),t.style.setProperty("opacity","1.0"),t.style.setProperty("visibility","visibile")}_createRenderer(t){if(this._config.renderer==i.NONE)return new f(i.NONE,t);const e=this._config.renderer==i.CANVAS?["2d","webgl2","webgl","experimental-webgl2","experimental-webgl"]:["webgl2","webgl","2d","experimental-webgl2","experimental-webgl"];let s=null;for(let i of e)if(s=t.getContext(i))break;return"undefined"!=typeof WebGL2RenderingContext&&s instanceof WebGL2RenderingContext||"undefined"!=typeof WebGLRenderingContext&&s instanceof WebGLRenderingContext?new S(this._game,t,s,this._config.glMaxTextures,this._config.glMaxVerts):"undefined"!=typeof CanvasRenderingContext2D&&s instanceof CanvasRenderingContext2D?new m(t,s):new f(i.NONE,t)}onStart(){this.canvas=this._getCanvas(this._config.canvas),this._initCanvas(this.canvas),this.renderer=this._createRenderer(this.canvas),this.renderer.resize(this._config.width,this._config.height)}onPreDraw(){this.renderer.onPreDraw()}onPostDraw(){this.renderer.onPostDraw()}onStop(){this.renderer.destroy(),this._canvasGenerated?this.canvas.parentNode.removeChild(this.canvas):this._canvasMemento.restore(this.canvas).clear()}_getCanvas(t){let e=document.body;if(this._canvasGenerated=!1,t instanceof HTMLCanvasElement)return t;if(t instanceof HTMLElement)e=t;else{const s=document.querySelectorAll(t);for(let t of s)if(t instanceof HTMLCanvasElement)return t;s.length>=1&&(e=s[0])}for(let t of e.childNodes)if(t instanceof HTMLCanvasElement)return t;const s=document.createElement("canvas");return e.appendChild(s),this._canvasGenerated=!0,s}}class U extends t{constructor(){super(),this.data={}}}class b{constructor(){this._json={}}has(t){return t in this._json}create(t){const e=new U,s=new XMLHttpRequest;return s.onreadystatechange=(()=>{if(s.readyState==XMLHttpRequest.DONE){if(s.onreadystatechange=g,s.status>=200&&s.status<=299)try{e.data=JSON.parse(s.responseText)}catch(s){console.warn(`Failed to parse ${t}: ${s}`),e.missing=!0}else console.warn(`Missing JSON: ${t}\nHTTP ${s.status}: ${s.statusText}`),e.missing=!0;e.loaded=!0}}),s.open("GET",t),s.send(null),e}load(t,e){return this.unload(t),this._json[t]=this.create(e),this._json[t]}unload(t){if(!this.has(t))return!1;const e=this._json[t];return e.loaded=!1,e.missing=!1,e.data={},delete this._json[t],!0}unloadAll(){for(let t in this._json)this.unload(t)}onStop(){this.unloadAll()}get(t){return this.has(t)?this._json[t]:null}getData(t){return this.has(t)?this._json[t].data:{}}}class L{constructor(t){this._enabled=t.enabled,this._keys={},this._keysNow={},this._keysLast={},this._keydownHandler=new d(document,"keydown",t=>this._onKeydown(t),{once:!1,passive:!0}),this._keyupHandler=new d(document,"keyup",t=>this._onKeyup(t),{once:!1,passive:!0})}down(t){return!!this._keysNow[t]&&!this._keysLast[t]}held(t){return!!this._keysNow[t]}up(t){return!this._keysNow[t]&&!!this._keysLast[t]}_onKeydown(t){this._keys[t.code]=!0}_onKeyup(t){this._keys[t.code]=!1}onStart(){this._enabled&&(this._keydownHandler.start(),this._keyupHandler.start())}onPreTick(){Object.assign(this._keysLast,this._keysNow),Object.assign(this._keysNow,this._keys)}onStop(){this._keydownHandler.stop(),this._keyupHandler.stop();for(let t in this._keys)this._keysLast[t]=this._keysNow[t]=this._keys[t]=!1}}class P{onCreate(t){}onEnter(t){}onTick(t){}onDraw(t){}onExit(t){}onDestroy(t){}}class C{constructor(t,e){this._game=t,this._config=e,this._KEY_DEFAULT="__sol_default__",this._keyActive=this._KEY_DEFAULT,this._keyNext=this._KEY_DEFAULT,this._changing=!1,this._scenes={},this._scenes[this._KEY_DEFAULT]=new P}has(t){return t!=this._KEY_DEFAULT&&t in this._scenes}create(t,e){return t!=this._KEY_DEFAULT&&(this.destroy(t),this._scenes[t]=new e,this._scenes[t].onCreate(this._game),!0)}change(t){return!!this.has(t)&&(this._keyNext=t,this._changing=!0,!0)}reload(){return this.change(this._keyActive)}destroy(t){return!!this.has(t)&&(this._scenes[t].onDestroy(this._game),(t==this._keyActive||this._changing&&t==this._keyNext)&&(this._keyActive=this._KEY_DEFAULT,this._keyNext=this._KEY_DEFAULT,this._changing=!1),delete this._scenes[t],!0)}onStart(){for(let t in this._config.scenes)this.create(t,this._config.scenes[t]);this.change(this._config.main)}onTick(){this._changing&&(this._scenes[this._keyActive].onExit(this._game),this._keyActive=this._keyNext,this._changing=!1,this._scenes[this._keyActive].onEnter(this._game)),this._scenes[this._keyActive].onTick(this._game)}onDraw(){this._scenes[this._keyActive].onDraw(this._game)}onStop(){for(let t in this._scenes)this.destroy(t)}get(t){return this.has(t)?this._scenes[t]:null}get key(){return this._keyActive}get changing(){return this._changing}get active(){return this._scenes[this._keyActive]}get keys(){const t=[];for(let e in this._scenes)this.has(e)&&t.push(e);return t}}const D={missing:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAIAQMAAAD+wSzIAAAABlBMVEX/AP8AAACfphTyAAAADklEQVQIHWMIZVjFgIQBHpwD/fruyDEAAAAASUVORK5CYII="};class I extends t{constructor(){super(),this.width=1,this.height=1,this.glTex=null,this.glBound=!1,this.glUnit=0,this.canvasImg=null,this.canvasCropScaleX=1,this.canvasCropScaleY=1}}class M{constructor(){this.glReturnTex=null,this.glReturnUnit=0}createTexture(t,e,s,i){const r=new I,n=new Image;return n.onload=(()=>{if(n.onload=g,n.onerror=g,r.width=s||n.naturalWidth,r.height=i||n.naturalHeight,t)return this.glOpenTexture(t,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n),void this.glCloseTexture(t,r);"undefined"!=typeof ImageBitmap?createImageBitmap(n,0,0,n.naturalWidth,n.naturalHeight,{resizeWidth:r.width,resizeHeight:r.height,resizeQuality:"pixelated"}).then(t=>{this.canvasCloseTexture(r,t)},t=>{console.warn(`Failed to create a bitmap for ${e}:\n${t}`),this.canvasCloseTexture(r,n)}):this.canvasCloseTexture(r,n)}),n.onerror=(()=>{n.onerror=g,console.warn(`Missing texture: ${e}`),r.missing=!0,n.src=D.missing}),n.src=e,r}destroyTexture(t,e){e.loaded=!1,e.missing=!1,t&&(t.activeTexture(t.TEXTURE0+e.glUnit),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(e.glTex),this.glReturnTex==e.glTex?this.glReturnTex=null:t.bindTexture(t.TEXTURE_2D,this.glReturnTex),t.activeTexture(t.TEXTURE0+this.glReturnUnit)),"undefined"!=typeof ImageBitmap&&e.canvasImg instanceof ImageBitmap&&e.canvasImg.close(),e.width=1,e.height=1,e.glTex=null,e.glBound=!1,e.glUnit=0,e.canvasImg=null,e.canvasCropScaleX=1,e.canvasCropScaleY=1}glOpenTexture(t,e){e.glTex=t.createTexture(),t.bindTexture(t.TEXTURE_2D,e.glTex),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)}glCloseTexture(t,e){t.bindTexture(t.TEXTURE_2D,this.glReturnTex),t.flush(),e.loaded=!0}glCreatePixel(t,e,s,i,r){const n=new I;return n.width=1,n.height=1,this.glOpenTexture(t,n),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([e,s,i,r])),this.glCloseTexture(t,n),n}canvasCloseTexture(t,e){t.canvasImg=e,t.canvasCropScaleX=e.width/t.width,t.canvasCropScaleY=e.height/t.height,t.loaded=!0}}class N{constructor(t){this._game=t,this._renderer,this._gl=null,this._textures={},this.factory=new M}has(t){return t in this._textures}create(t,e=0,s=0){return this.factory.createTexture(this._gl,t,e,s)}draw(t,e=0,s=0,i=null,r=null,n=0,h=0,a=null,o=null){const _=this._textures[t];null==i&&(i=_.width),null==r&&(r=_.height),null==a&&(a=_.width-n),null==o&&(o=_.height-h),this._renderer.applyTexture(_),this._renderer.drawTexture(e,s,i,r,n,h,a,o)}load(t,e,s=0,i=0){return this.unload(t),this._textures[t]=this.create(e,s,i),this._textures[t]}unload(t){return!!this.has(t)&&(this.factory.destroyTexture(this._gl,this._textures[t]),delete this._textures[t],!0)}unloadAll(){for(let t in this._textures)this.unload(t)}onStart(){this._renderer=this._game.gfx.renderer,this._gl=this._renderer.gl}onStop(){this.unloadAll()}get(t){return this.has(t)?this._textures[t]:null}}class k{constructor(){this._MIN_DELTA=1e-5,this._MAX_DELTA=1,this._delta=1,this._fps=1}onPreTick(t){this._delta=h(t,this._MIN_DELTA,this._MAX_DELTA),this._fps=1/t}get delta(){return this._delta}get fps(){return this._fps}}function B(t,e){for(let s in e)e.hasOwnProperty(s)&&"object"!=typeof e[s]&&"function"!=typeof e[s]&&(t[s]=e[s])}const F={asset:{Asset:t,Loader:s},core:{util:{consoleSplash:r,getCompatible:n},Config:l,Loop:u},dom:{ElemMemento:c,EventHandler:d},gfx:{canvas:{CanvasRenderer:m},webgl:{shaderSrc:p,util:{createShader:T,parseShader:E},MVPMatrix:v,Program:y,TextureCache:A,VertBuffer:w,WebGLRenderer:S},GfxManager:R,GfxManagerConfig:a,Renderer:f},json:{JsonFile:U,JsonManager:b},key:{KeyManager:L,KeyManagerConfig:o},math:{clamp:h,OrthoMatrix:x},scene:{SceneManager:C,SceneManagerConfig:_},texture:{imgSrc:D,Texture:I,TextureFactory:M,TextureManager:N},time:{TimeManager:k},util:{object:{shallowExtend:B,getDefault:e},noop:g},Game:class{constructor(t={}){const e=new l(t);this._loop=new u(this),this.gfx=new R(this,e.gfx),this.json=new b,this.key=new L(e.key),this.scene=new C(this,e.scene),this.texture=new N(this),this.time=new k,this.loader=new s(this),e.autoStart&&this.start()}start(){return this._loop.start()}restart(){return this._loop.restart()}stop(){return this._loop.stop()}get running(){return this._loop.running}get delta(){return this.time.delta}get fps(){return this.time.fps}},Scene:P};return B(F,i),F}();
